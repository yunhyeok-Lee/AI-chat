<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", sans-serif;
        background-color: #f3f4f6;
        color: #1f2937;
      }
      body {
        margin: 0;
        display: flex;
        min-height: 100vh;
        justify-content: center;
        align-items: center;
      }
      .chat-wrapper {
        width: min(640px, 100vw - 32px);
        height: min(720px, 100vh - 32px);
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(15, 23, 42, 0.12);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      header {
        padding: 16px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white;
      }
      #model-name {
        font-size: 0.85rem;
        opacity: 0.8;
      }
      .history {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #f9fafb;
      }
      .bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
      }
      .user {
        align-self: flex-end;
        background: #6366f1;
        color: white;
        border-bottom-right-radius: 4px;
      }
      .assistant {
        align-self: flex-start;
        background: #e0e7ff;
        border-bottom-left-radius: 4px;
      }
      .error {
        align-self: center;
        background: #fee2e2;
        color: #991b1b;
      }
      form {
        padding: 16px 24px;
        display: flex;
        gap: 12px;
        border-top: 1px solid #e5e7eb;
        background: white;
      }
      input[type="text"] {
        flex: 1;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid #cbd5f5;
        font-size: 1rem;
      }
      button {
        padding: 12px 20px;
        border-radius: 12px;
        border: none;
        background: #6366f1;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      button:disabled {
        background: #a5b4fc;
        cursor: not-allowed;
      }
      @media (max-width: 600px) {
        :root {
          background-color: #ffffff;
        }
        .chat-wrapper {
          width: 100%;
          height: 100vh;
          border-radius: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <header>
        <h1>AI 챗봇</h1>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span id="model-name"></span>
          <button id="clear-history" style="background: rgba(255,255,255,0.2); padding: 6px 12px; font-size: 0.8rem;">대화 지우기</button>
        </div>
      </header>
      <div id="history" class="history" role="log" aria-live="polite"></div>
      <form id="chat-form" autocomplete="off">
        <input
          id="message-input"
          type="text"
          placeholder="메시지를 입력하세요..."
          aria-label="Message input"
          required
        />
        <button id="send-button" type="submit">전송</button>
      </form>
    </div>
    <script>
      const historyEl = document.getElementById("history");
      const modelNameEl = document.getElementById("model-name");
      const formEl = document.getElementById("chat-form");
      const inputEl = document.getElementById("message-input");
      const sendButtonEl = document.getElementById("send-button");
      const clearHistoryBtn = document.getElementById("clear-history");
      
      // 로컬스토리지 키
      const STORAGE_KEY = "chatbot_history";

      function appendMessage(role, text) {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = text;
        historyEl.appendChild(bubble);
        historyEl.scrollTop = historyEl.scrollHeight;
        
        // 로컬스토리지에 저장 (에러 메시지는 저장하지 않음)
        if (role !== "error") {
          saveMessageToStorage(role, text);
        }
      }

      function setLoadingState(isLoading) {
        sendButtonEl.disabled = isLoading;
        sendButtonEl.textContent = isLoading ? "전송 중..." : "전송";
        inputEl.disabled = isLoading;
      }

      // 로컬스토리지에 대화 기록 저장
      function saveMessageToStorage(role, text) {
        try {
          const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
          history.push({ role, text, timestamp: new Date().toISOString() });
          // 최대 100개 메시지만 저장 (메모리 관리)
          if (history.length > 100) {
            history.splice(0, history.length - 100);
          }
          localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        } catch (error) {
          console.warn("로컬스토리지 저장 실패:", error);
        }
      }

      // 로컬스토리지에서 대화 기록 불러오기
      function loadHistoryFromStorage() {
        try {
          const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
          history.forEach(item => {
            if (item.role && item.text) {
              const bubble = document.createElement("div");
              bubble.className = `bubble ${item.role}`;
              bubble.textContent = item.text;
              historyEl.appendChild(bubble);
            }
          });
          historyEl.scrollTop = historyEl.scrollHeight;
        } catch (error) {
          console.warn("로컬스토리지 불러오기 실패:", error);
        }
      }

      // 대화 기록 초기화
      function clearChatHistory() {
        if (confirm("모든 대화 기록을 삭제하시겠습니까?")) {
          localStorage.removeItem(STORAGE_KEY);
          historyEl.innerHTML = "";
        }
      }

      formEl.addEventListener("submit", async (event) => {
        event.preventDefault();
        const message = inputEl.value.trim();
        if (!message) {
          return;
        }
        appendMessage("user", message);
        inputEl.value = "";
        setLoadingState(true);

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Request failed.");
          }

          if (data.model) {
            modelNameEl.textContent = data.model;
          }
          appendMessage("assistant", data.reply);
        } catch (error) {
          appendMessage("error", error.message || "오류가 발생했습니다. 다시 시도해주세요.");
        } finally {
          setLoadingState(false);
        }
      });

      // 대화 기록 지우기 버튼 이벤트
      clearHistoryBtn.addEventListener("click", clearChatHistory);

      // 페이지 로드 시 대화 기록 불러오기
      document.addEventListener("DOMContentLoaded", () => {
        loadHistoryFromStorage();
      });

      // Enter 키로 전송 (Shift+Enter는 줄바꿈)
      inputEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          formEl.dispatchEvent(new Event("submit"));
        }
      });
    </script>
  </body>
</html>
